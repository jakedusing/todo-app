<%- include("partials/header") %>
<main class="container mt-5">
  <!-- Flash Messages-->
   <% if (success_msg.length > 0) {%>
    <div class="alert alert-success alert-dismissible fade show" role="alert">
      <%= success_msg %>
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <% } %>

    <% if (error_msg.length > 0) {%>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error_msg %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      <% } %>


  <h1 class="text-center mb-4">Welcome to your Dashboard, <%= username %></h1>

  <!-- Form to add a new personal todo -->
   <section class="mb-5">
    <div class="container d-flex justify-content-center align-items-center" style="min-height: 40vh;">
      <div class="w-100" style="max-width: 500px;">
        <h3 class="text-center mb-4">Add a New Personal Todo</h3>
        <form action="/todos/add" method="POST" class="d-flex flex-column gap-3">
          <input type="text" name="title" class="form-control" placeholder="Enter todo" required />
          <input type="date" name="dueDate" class="form-control" />
          <select name="priority" class="form-select">
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
          </select>
          <button type="submit" class="btn btn-primary mt-3">Add Todo</button>
        </form>
      </div>
    </div>
   </section>

  <!-- Personal Incomplete Todos // Not assigned by others from a group -->
  <section class="mb-5">
    <h2>Your Incomplete Todos</h2>
    <% if (incompleteSelfCreatedTodos && incompleteSelfCreatedTodos.length > 0) { %>
      <ul class="list-group">
        <% incompleteSelfCreatedTodos.forEach((todo) => { %> <!-- Added the arrow function syntax -->
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong><%= todo.title %></strong>
              - Due: <%= todo.dueDate ? todo.dueDate.toLocaleDateString() : "No due date" %>
              - Priority: <span class="badge <%= todo.priority === "High" ? "bg-danger" : todo.priority === "Medium" ? "bg-warning" : "bg-secondary" %>">
                <%= todo.priority %>
              </span>
            </div>
            <div>
              <form action="/todos/toggle/<%= todo._id %>" method="POST" class="d-inline">
                <button type="submit" class="btn btn-success btn-sm">Mark Complete</button>
              </form>
              <form action="/todos/delete/<%= todo._id %>" method="POST" class="d-inline">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </div>
          </li>
        <% }); %> <!-- Closing the forEach correctly -->
      </ul>
    <% } else { %>
      <p class="text-muted">No incomplete personal todos!</p>
    <% } %>
  </section>
  
  <!-- Personal Completed Todos -->
  <section class="mb-5">
    <h2>Your Completed Personal Todos</h2>
    <% if (completedSelfCreatedTodos && completedSelfCreatedTodos.length > 0) { %>
      <ul class="list-group">
        <% completedSelfCreatedTodos.forEach((todo) => { %> 
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <s><strong><%= todo.title %></strong></s>
              - Completed on: <%= todo.updatedAt ? todo.updatedAt.toLocaleDateString() : "Unknown" %>
            </div>
            <div>
              <form action="/todos/toggle/<%= todo._id %>" method="POST" class="d-inline">
                <button type="submit" class="btn btn-warning btn-sm">Mark Incomplete</button>
              </form>
              <form action="/todos/delete/<%= todo._id %>" method="POST" class="d-inline">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </div>
          </li>
        <% }); %>
      </ul>
    <% } else { %>
      <p class="text-muted">No completed personal todos!</p>
    <% } %>
  </section>

   <!-- Section for Assigned Todos -->
    <section class="mb-5">
      <h2>Group Todos Assigned to You</h2>
      <% if (incompleteAssignedTodos.length > 0 || completedAssignedTodos.length > 0) { %>
        <h3>Incomplete Todos</h3>
        <% if (incompleteAssignedTodos.length > 0) {%>
          <ul class="list-group">
            <% incompleteAssignedTodos.forEach((todo) => { %>
              <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                  <strong><%= todo.title %></strong>
                  - Due: <%= todo.dueDate ? todo.dueDate.toLocaleDateString() : "No due date" %>
                  - Priority: <span class="badge <%= todo.priority === "High" ? "bg-danger" : todo.priority === "Medium" ? "bg-warning" : "bg-secondary"%>"><%= todo.priority %></span>
                  <br /> Group: <%= todo.groupId.name %>
                </div>
                <form action="/todos/toggle/<%= todo._id %>" method="POST" class="d-inline">
                  <button type="submit" class="btn btn-success btn-sm">Mark Complete</button>
                </form>
              </li>
              <% }); %>
          </ul>
          <% } else { %>
            <p class="text-muted">No incomplete todos assigned to you!</p>
            <% } %>

            <h3>Completed Todos</h3>
            <% if (completedAssignedTodos.length > 0) {%>
              <ul class="list-group">
                <% completedAssignedTodos.forEach((todo) => { %>
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                      <s><strong><%= todo.title %></strong></s>
                      - Due: <%= todo.dueDate ? todo.dueDate.toLocaleDateString() : "No due date" %>
                      - Priority: <span class="badge <%= todo.priority === "High" ? "bg-danger" : todo.priority === "Medium" ? "bg-warning" : "bg-secondary"%>"><%= todo.priority %></span>
                      <span class="badge bg-success">Completed</span>
                      <br />
                      <% if (todo.groupId) {%>
                      - Group: <%= todo.groupId.name %>
                    </div>
                    <a href="/groups/<%= todo.groupId._id %>" class="btn btn-primary btn-sm">View Group</a>
                    <% } else { %>
                      - No group assigned.
                      <% } %>
                  </li>
                  <% }); %>
              </ul>
                  <% } else { %>
                    <p class="text-muted">No completed todos assigned to you!</p>
                    <% } %>
                    <% } %>
    </section>

  <a href="/auth/logout">Logout</a>
</main>
<%- include("partials/footer"); %>
